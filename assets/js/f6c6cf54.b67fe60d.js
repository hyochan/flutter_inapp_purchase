"use strict";(self.webpackChunkflutter_inapp_purchase_docs=self.webpackChunkflutter_inapp_purchase_docs||[]).push([[8992],{1427:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>u,contentTitle:()=>o,default:()=>h,frontMatter:()=>c,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"api/methods/request-purchase","title":"requestPurchase","description":"Initiates a purchase flow for the specified product.","source":"@site/docs/api/methods/request-purchase.md","sourceDirName":"api/methods","slug":"/api/methods/request-purchase","permalink":"/flutter_inapp_purchase/api/methods/request-purchase","draft":false,"unlisted":false,"editUrl":"https://github.com/hyochan/flutter_inapp_purchase/tree/main/docs/docs/api/methods/request-purchase.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4,"title":"requestPurchase"}}');var i=n(74848),a=n(28453),t=n(35159);const c={sidebar_position:4,title:"requestPurchase"},o="requestPurchase()",u={},d=[{value:"Overview",id:"overview",level:2},{value:"Signature",id:"signature",level:2},{value:"Parameters",id:"parameters",level:2},{value:"Request Structure",id:"request-structure",level:2},{value:"RequestPurchaseProps (v8.2.0+ Recommended)",id:"requestpurchaseprops-v820-recommended",level:3},{value:"RequestPurchase (Legacy)",id:"requestpurchase-legacy",level:3},{value:"RequestPurchaseIOS",id:"requestpurchaseios",level:3},{value:"RequestPurchaseAndroid",id:"requestpurchaseandroid",level:3},{value:"Usage Examples",id:"usage-examples",level:2},{value:"Basic Purchase (Recommended v8.2.0+)",id:"basic-purchase-recommended-v820",level:3},{value:"Purchase with User Identifier",id:"purchase-with-user-identifier",level:3},{value:"Subscription with Promotional Offer (iOS)",id:"subscription-with-promotional-offer-ios",level:3},{value:"Subscription Upgrade/Downgrade (Android)",id:"subscription-upgradedowngrade-android",level:3},{value:"Purchase with Attribution Data (iOS 15+)",id:"purchase-with-attribution-data-ios-15",level:3},{value:"Complete Implementation",id:"complete-implementation",level:2},{value:"Handling Purchase Results",id:"handling-purchase-results",level:2},{value:"Android Proration Modes",id:"android-proration-modes",level:2},{value:"Best Practices",id:"best-practices",level:2},{value:"Error Handling",id:"error-handling",level:2},{value:"Using the Builder DSL",id:"using-the-builder-dsl",level:2},{value:"Related Methods",id:"related-methods",level:2},{value:"Platform Notes",id:"platform-notes",level:2},{value:"iOS",id:"ios",level:3},{value:"Android",id:"android",level:3}];function l(e){const r={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(r.header,{children:(0,i.jsx)(r.h1,{id:"requestpurchase",children:"requestPurchase()"})}),"\n",(0,i.jsx)(t.A,{}),"\n",(0,i.jsx)(r.p,{children:"Initiates a purchase flow for the specified product."}),"\n",(0,i.jsx)(r.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsxs)(r.p,{children:["The ",(0,i.jsx)(r.code,{children:"requestPurchase()"})," method starts the platform's native purchase flow for a product. It handles both one-time purchases and subscriptions with platform-specific options."]}),"\n",(0,i.jsx)(r.h2,{id:"signature",children:"Signature"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-dart",children:"Future<void> requestPurchase({\n  required RequestPurchase request,\n  required PurchaseType type,\n})\n"})}),"\n",(0,i.jsx)(r.h2,{id:"parameters",children:"Parameters"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"request"})," - Platform-specific purchase request parameters"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"type"})," - Type of purchase (",(0,i.jsx)(r.code,{children:"PurchaseType.inapp"})," or ",(0,i.jsx)(r.code,{children:"PurchaseType.subs"}),")"]}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"request-structure",children:"Request Structure"}),"\n",(0,i.jsx)(r.h3,{id:"requestpurchaseprops-v820-recommended",children:"RequestPurchaseProps (v8.2.0+ Recommended)"}),"\n",(0,i.jsx)(r.p,{children:"Use the factory constructors for type-safe purchase requests:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-dart",children:"// For in-app products\nRequestPurchaseProps.inApp((\n  apple: RequestPurchaseIosProps(sku: 'product_id'),\n  google: RequestPurchaseAndroidProps(skus: ['product_id']),\n))\n\n// For subscriptions\nRequestPurchaseProps.subs((\n  apple: RequestPurchaseIosProps(sku: 'subscription_id'),\n  google: RequestPurchaseAndroidProps(skus: ['subscription_id']),\n))\n"})}),"\n",(0,i.jsx)(r.h3,{id:"requestpurchase-legacy",children:"RequestPurchase (Legacy)"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-dart",children:"class RequestPurchase {\n  final RequestPurchaseIOS? ios;\n  final RequestPurchaseAndroid? android;\n}\n"})}),"\n",(0,i.jsx)(r.h3,{id:"requestpurchaseios",children:"RequestPurchaseIOS"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-dart",children:"class RequestPurchaseIOS {\n  final String sku;                    // Product ID\n  final int? quantity;                 // Quantity (for consumables)\n  final String? appAccountToken;       // User identifier (must be UUID format)\n  final Map<String, dynamic>? withOffer; // Promotional offer\n  final String? advancedCommerceData; // Attribution data (iOS 15+)\n}\n"})}),"\n",(0,i.jsx)(r.h3,{id:"requestpurchaseandroid",children:"RequestPurchaseAndroid"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-dart",children:"class RequestPurchaseAndroid {\n  final List<String> skus;             // Product IDs\n  final String? obfuscatedAccountIdAndroid;  // User identifier\n  final String? obfuscatedProfileIdAndroid;  // Profile identifier\n  final String? purchaseToken;         // For upgrades/downgrades\n  final int? offerTokenIndex;          // Specific offer index\n  final int? prorationMode;            // Subscription proration\n}\n"})}),"\n",(0,i.jsx)(r.h2,{id:"usage-examples",children:"Usage Examples"}),"\n",(0,i.jsx)(r.h3,{id:"basic-purchase-recommended-v820",children:"Basic Purchase (Recommended v8.2.0+)"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-dart",children:"// Simple product purchase using RequestPurchaseProps\nawait FlutterInappPurchase.instance.requestPurchase(\n  RequestPurchaseProps.inApp((\n    apple: RequestPurchaseIosProps(sku: 'com.example.premium'),\n    google: RequestPurchaseAndroidProps(skus: ['com.example.premium']),\n  )),\n);\n"})}),"\n",(0,i.jsx)(r.h3,{id:"purchase-with-user-identifier",children:"Purchase with User Identifier"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-dart",children:"// Purchase with user account token for restoration\nawait FlutterInappPurchase.instance.requestPurchase(\n  RequestPurchaseProps.inApp((\n    apple: RequestPurchaseIosProps(\n      sku: 'com.example.premium',\n      appAccountToken: userId, // Must be UUID format (e.g., '550e8400-e29b-41d4-a716-446655440000')\n    ),\n    google: RequestPurchaseAndroidProps(\n      skus: ['com.example.premium'],\n      obfuscatedAccountIdAndroid: userId,\n    ),\n  )),\n);\n"})}),"\n",(0,i.jsx)(r.h3,{id:"subscription-with-promotional-offer-ios",children:"Subscription with Promotional Offer (iOS)"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-dart",children:"// iOS subscription with promotional offer\nawait FlutterInappPurchase.instance.requestPurchase(\n  RequestPurchaseProps.subs((\n    apple: RequestPurchaseIosProps(\n      sku: 'com.example.monthly',\n      withOffer: PaymentDiscount(\n        identifier: 'promo_50_off',\n        keyIdentifier: 'ABCDEF123456',\n        nonce: generateNonce(),\n        signature: generateSignature(), // Server-generated\n        timestamp: DateTime.now().millisecondsSinceEpoch,\n      ),\n    ),\n    google: RequestPurchaseAndroidProps(skus: ['com.example.monthly']),\n  )),\n);\n"})}),"\n",(0,i.jsx)(r.h3,{id:"subscription-upgradedowngrade-android",children:"Subscription Upgrade/Downgrade (Android)"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-dart",children:"// Android subscription change with proration\nawait FlutterInappPurchase.instance.requestPurchase(\n  RequestPurchaseProps.subs((\n    apple: RequestPurchaseIosProps(sku: 'com.example.yearly'),\n    google: RequestPurchaseAndroidProps(\n      skus: ['com.example.yearly'],\n      purchaseToken: currentSubscriptionToken,\n      prorationMode: AndroidProrationMode.IMMEDIATE_AND_CHARGE_PRORATED_PRICE,\n    ),\n  )),\n);\n"})}),"\n",(0,i.jsx)(r.h3,{id:"purchase-with-attribution-data-ios-15",children:"Purchase with Attribution Data (iOS 15+)"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-dart",children:"// iOS purchase with advanced commerce data for attribution tracking\nawait FlutterInappPurchase.instance.requestPurchaseWithBuilder(\n  build: (builder) {\n    builder.ios.sku = 'com.example.premium';\n    builder.ios.advancedCommerceData = 'campaign_summer_2025';\n    builder.type = ProductQueryType.InApp;\n  },\n);\n"})}),"\n",(0,i.jsxs)(r.p,{children:["The ",(0,i.jsx)(r.code,{children:"advancedCommerceData"})," field uses StoreKit 2's ",(0,i.jsx)(r.code,{children:"Product.PurchaseOption.custom"})," API to pass campaign tokens, affiliate IDs, or other attribution data during purchases."]}),"\n",(0,i.jsx)(r.h2,{id:"complete-implementation",children:"Complete Implementation"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-dart",children:"class PurchaseService {\n  final _iap = FlutterInappPurchase.instance;\n\n  Future<void> purchaseProduct(String productId, {bool isSubscription = false}) async {\n    try {\n      final userId = await _getUserId();\n\n      // Initiate purchase using RequestPurchaseProps (v8.2.0+)\n      if (isSubscription) {\n        await _iap.requestPurchase(\n          RequestPurchaseProps.subs((\n            apple: RequestPurchaseIosProps(\n              sku: productId,\n              appAccountToken: userId, // Must be UUID format\n            ),\n            google: RequestPurchaseAndroidProps(\n              skus: [productId],\n              obfuscatedAccountIdAndroid: userId,\n            ),\n          )),\n        );\n      } else {\n        await _iap.requestPurchase(\n          RequestPurchaseProps.inApp((\n            apple: RequestPurchaseIosProps(\n              sku: productId,\n              appAccountToken: userId, // Must be UUID format\n            ),\n            google: RequestPurchaseAndroidProps(\n              skus: [productId],\n              obfuscatedAccountIdAndroid: userId,\n            ),\n          )),\n        );\n      }\n\n      // Purchase result will be received via purchaseUpdatedListener stream\n\n    } on PurchaseError catch (e) {\n      _handlePurchaseError(e);\n    } catch (e) {\n      print('Unexpected error: $e');\n    }\n  }\n\n  void _handlePurchaseError(PurchaseError error) {\n    switch (error.code) {\n      case ErrorCode.UserCancelled:\n        print('User cancelled the purchase');\n        break;\n      case ErrorCode.AlreadyOwned:\n        print('Product already owned');\n        break;\n      case ErrorCode.ServiceError:\n        print('Billing service unavailable');\n        break;\n      default:\n        print('Purchase error: ${error.message}');\n    }\n  }\n\n  Future<String?> _getUserId() async {\n    // Return your user identifier\n    return 'user123';\n  }\n}\n"})}),"\n",(0,i.jsx)(r.h2,{id:"handling-purchase-results",children:"Handling Purchase Results"}),"\n",(0,i.jsx)(r.p,{children:"Purchase results are delivered through streams:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-dart",children:"// Listen to successful purchases\nFlutterInappPurchase.instance.purchaseUpdatedListener.listen((purchase) {\n  print('Purchase successful: ${purchase.productId}');\n\n  // Handle purchase state (v8.2.0+: unified across platforms)\n  switch (purchase.purchaseState) {\n    case PurchaseState.Purchased:\n      // Verify the purchase\n      _verifyPurchase(purchase);\n      // Deliver the content\n      _deliverContent(purchase.productId);\n      // Finish the transaction\n      _finishTransaction(purchase);\n      break;\n    case PurchaseState.Pending:\n      print('Purchase pending');\n      break;\n    case PurchaseState.Unknown:\n      print('Unknown purchase state');\n      break;\n  }\n});\n\n// Listen to purchase errors\nFlutterInappPurchase.instance.purchaseErrorListener.listen((error) {\n  print('Purchase failed: ${error.message}');\n});\n"})}),"\n",(0,i.jsx)(r.h2,{id:"android-proration-modes",children:"Android Proration Modes"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-dart",children:"class AndroidProrationMode {\n  static const int IMMEDIATE_AND_CHARGE_FULL_PRICE = 5;\n  static const int DEFERRED = 4;\n  static const int IMMEDIATE_AND_CHARGE_PRORATED_PRICE = 2;\n  static const int IMMEDIATE_WITHOUT_PRORATION = 3;\n  static const int IMMEDIATE_WITH_TIME_PRORATION = 1;\n  static const int UNKNOWN_SUBSCRIPTION_UPGRADE_DOWNGRADE_POLICY = 0;\n}\n"})}),"\n",(0,i.jsx)(r.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,i.jsxs)(r.ol,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"User Identification"}),": Always include a user identifier for purchase restoration"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Error Handling"}),": Implement comprehensive error handling for all failure cases"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Loading State"}),": Show loading indicator during purchase flow"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Double Purchase Prevention"}),": Disable purchase button after click"]}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-dart",children:"Future<void> safePurchase(String productId) async {\n  // Prevent double purchases\n  if (_isPurchasing) return;\n  _isPurchasing = true;\n\n  try {\n    await _iap.requestPurchase(\n      RequestPurchaseProps.inApp((\n        apple: RequestPurchaseIosProps(sku: productId),\n        google: RequestPurchaseAndroidProps(skus: [productId]),\n      )),\n    );\n  } catch (e) {\n    // Handle errors\n    if (e is PurchaseError) {\n      switch (e.code) {\n        case ErrorCode.NotInitialized:\n          // Reinitialize connection\n          await _iap.initConnection();\n          break;\n        case ErrorCode.ItemUnavailable:\n          // Product not available\n          showError('Product not available');\n          break;\n        default:\n          showError(e.message);\n      }\n    }\n  } finally {\n    _isPurchasing = false;\n  }\n}\n"})}),"\n",(0,i.jsx)(r.h2,{id:"using-the-builder-dsl",children:"Using the Builder DSL"}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.code,{children:"requestPurchaseWithBuilder"})," exposes a fluent builder for composing\nplatform-specific purchase parameters without manual object construction."]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-dart",children:"await FlutterInappPurchase.instance.requestPurchaseWithBuilder(\n  build: (RequestPurchaseBuilder r) => r\n    ..type = ProductType.Subs\n    ..withIOS((RequestPurchaseIosBuilder i) => i..sku = 'your.sku1')\n    ..withAndroid(\n      (RequestPurchaseAndroidBuilder a) => a..skus = ['your.sku1'],\n    ),\n);\n"})}),"\n",(0,i.jsx)(r.p,{children:"Use the builder when you:"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"Need to configure different options per platform."}),"\n",(0,i.jsx)(r.li,{children:"Prefer a DSL-style API with chained modifiers."}),"\n",(0,i.jsxs)(r.li,{children:["Want safeguards against unsupported ",(0,i.jsx)(r.code,{children:"ProductType.All"})," usage\u2014the builder only\nallows in-app or subscription types."]}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"related-methods",children:"Related Methods"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.a,{href:"/flutter_inapp_purchase/api/methods/get-products",children:(0,i.jsx)(r.code,{children:"fetchProducts()"})})," - Fetch products before purchasing"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.a,{href:"/flutter_inapp_purchase/api/methods/finish-transaction",children:(0,i.jsx)(r.code,{children:"finishTransaction()"})})," - Complete the purchase"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.a,{href:"/flutter_inapp_purchase/api/methods/request-subscription",children:(0,i.jsx)(r.code,{children:"requestPurchase()"})})," - Legacy subscription method"]}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"platform-notes",children:"Platform Notes"}),"\n",(0,i.jsx)(r.h3,{id:"ios",children:"iOS"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"Requires valid product IDs from App Store Connect"}),"\n",(0,i.jsx)(r.li,{children:"Promotional offers need server-side signature"}),"\n",(0,i.jsx)(r.li,{children:"Quantity only works for consumable products"}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"advancedCommerceData"})," requires iOS 15+ and StoreKit 2"]}),"\n"]}),"\n",(0,i.jsx)(r.h3,{id:"android",children:"Android"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"Supports multiple SKUs but typically uses one"}),"\n",(0,i.jsx)(r.li,{children:"Proration modes only apply to subscriptions"}),"\n",(0,i.jsx)(r.li,{children:"Requires acknowledgment within 3 days"}),"\n",(0,i.jsxs)(r.li,{children:["Use ",(0,i.jsx)(r.code,{children:"google"})," field for request parameters (v8.2.0+)"]}),"\n"]})]})}function h(e={}){const{wrapper:r}={...(0,a.R)(),...e.components};return r?(0,i.jsx)(r,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},27856:(e,r,n)=>{n.d(r,{I:()=>i,V:()=>s});const s="https://iapkit.com",i="https://www.hyo.dev/api/ad-banner/cmjf0l1x30001249hbi91aop6"},28453:(e,r,n)=>{n.d(r,{R:()=>t,x:()=>c});var s=n(96540);const i={},a=s.createContext(i);function t(e){const r=s.useContext(a);return s.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function c(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:t(e.components),s.createElement(a.Provider,{value:r},e.children)}},35159:(e,r,n)=>{n.d(r,{A:()=>a});n(96540);var s=n(27856),i=n(74848);function a({style:e}){return(0,i.jsx)("div",{style:{marginTop:24,marginBottom:24,textAlign:"center",...e},children:(0,i.jsx)("a",{href:s.V,target:"_blank",rel:"noopener noreferrer",onClick:async()=>{try{await fetch(s.I,{method:"POST",mode:"no-cors"})}catch(e){}},children:(0,i.jsx)("img",{src:n(65860).A,alt:"IapKit - Fraud-proof your in-app purchases",style:{objectFit:"cover",border:"none"}})})})}},65860:(e,r,n)=>{n.d(r,{A:()=>s});const s=n.p+"assets/images/iapkit-banner-c71d8c3f875ca90b812e7b54822795d2.gif"}}]);