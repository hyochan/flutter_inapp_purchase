"use strict";(self.webpackChunkflutter_inapp_purchase_docs=self.webpackChunkflutter_inapp_purchase_docs||[]).push([[7e3],{3382:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>t,default:()=>h,frontMatter:()=>r,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"guides/lifecycle","title":"Purchase Lifecycle","description":"Understanding the complete purchase lifecycle is essential for proper implementation.","source":"@site/versioned_docs/version-7.0/guides/lifecycle.md","sourceDirName":"guides","slug":"/guides/lifecycle","permalink":"/flutter_inapp_purchase/docs/7.0/guides/lifecycle","draft":false,"unlisted":false,"editUrl":"https://github.com/hyochan/flutter_inapp_purchase/tree/main/docs/versioned_docs/version-7.0/guides/lifecycle.md","tags":[],"version":"7.0","sidebarPosition":2,"frontMatter":{"sidebar_position":2,"title":"Purchase Lifecycle"}}');var a=s(4848),c=s(8453);const r={sidebar_position:2,title:"Purchase Lifecycle"},t="Purchase Lifecycle",l={},d=[{value:"OpenIAP Lifecycle Documentation",id:"openiap-lifecycle-documentation",level:2},{value:"Lifecycle Phases",id:"lifecycle-phases",level:2},{value:"1. Connection Phase",id:"1-connection-phase",level:3},{value:"2. Product Discovery Phase",id:"2-product-discovery-phase",level:3},{value:"3. Purchase Initiation Phase",id:"3-purchase-initiation-phase",level:3},{value:"4. Transaction Processing Phase",id:"4-transaction-processing-phase",level:3},{value:"5. Content Delivery Phase",id:"5-content-delivery-phase",level:3},{value:"6. Transaction Finalization Phase",id:"6-transaction-finalization-phase",level:3},{value:"Purchase State Management",id:"purchase-state-management",level:2},{value:"Track Purchase States",id:"track-purchase-states",level:3},{value:"Pending Transactions",id:"pending-transactions",level:2},{value:"Best Practices",id:"best-practices",level:2},{value:"Next Steps",id:"next-steps",level:2}];function o(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,c.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"purchase-lifecycle",children:"Purchase Lifecycle"})}),"\n",(0,a.jsx)(n.p,{children:"Understanding the complete purchase lifecycle is essential for proper implementation."}),"\n",(0,a.jsx)(n.h2,{id:"openiap-lifecycle-documentation",children:"OpenIAP Lifecycle Documentation"}),"\n",(0,a.jsx)(n.p,{children:"For detailed lifecycle documentation, flow diagrams, and state management:"}),"\n",(0,a.jsxs)(n.p,{children:["\ud83d\udc49 ",(0,a.jsx)(n.strong,{children:(0,a.jsx)(n.a,{href:"https://openiap.dev/docs/lifecycle",children:"OpenIAP Lifecycle Documentation"})})]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:"https://openiap.dev/purchase-flow.png",alt:"Purchase Flow"})}),"\n",(0,a.jsx)(n.h2,{id:"lifecycle-phases",children:"Lifecycle Phases"}),"\n",(0,a.jsx)(n.h3,{id:"1-connection-phase",children:"1. Connection Phase"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dart",children:"// Initialize connection to store\nfinal connected = await FlutterInappPurchase.instance.initConnection();\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"States"}),": ",(0,a.jsx)(n.code,{children:"disconnected"})," \u2192 ",(0,a.jsx)(n.code,{children:"connecting"})," \u2192 ",(0,a.jsx)(n.code,{children:"connected"})]}),"\n",(0,a.jsx)(n.h3,{id:"2-product-discovery-phase",children:"2. Product Discovery Phase"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dart",children:"// Fetch available products\nfinal products = await iap.fetchProducts(\n  skus: productIds,\n  type: ProductQueryType.inApp,\n);\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"States"}),": ",(0,a.jsx)(n.code,{children:"idle"})," \u2192 ",(0,a.jsx)(n.code,{children:"loading"})," \u2192 ",(0,a.jsx)(n.code,{children:"loaded"})," / ",(0,a.jsx)(n.code,{children:"error"})]}),"\n",(0,a.jsx)(n.h3,{id:"3-purchase-initiation-phase",children:"3. Purchase Initiation Phase"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dart",children:"// User initiates purchase\nawait iap.requestPurchase(\n  sku: productId,\n  obfuscatedAccountIdAndroid: userId,\n);\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"States"}),": ",(0,a.jsx)(n.code,{children:"idle"})," \u2192 ",(0,a.jsx)(n.code,{children:"purchasing"})," \u2192 ",(0,a.jsx)(n.code,{children:"purchased"})," / ",(0,a.jsx)(n.code,{children:"failed"})," / ",(0,a.jsx)(n.code,{children:"cancelled"})]}),"\n",(0,a.jsx)(n.h3,{id:"4-transaction-processing-phase",children:"4. Transaction Processing Phase"}),"\n",(0,a.jsx)(n.p,{children:"Platform handles payment and returns result via streams:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dart",children:"_purchaseUpdatedSubscription = iap.purchaseUpdatedListener.listen(\n  (purchase) {\n    // Purchase successful\n    debugPrint('Purchase received: ${purchase.productId}');\n  },\n);\n\n_purchaseErrorSubscription = iap.purchaseErrorListener.listen(\n  (error) {\n    // Purchase failed\n    debugPrint('Purchase error: ${error.message}');\n  },\n);\n"})}),"\n",(0,a.jsx)(n.h3,{id:"5-content-delivery-phase",children:"5. Content Delivery Phase"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dart",children:"// Validate purchase on your server\nfinal isValid = await verifyPurchaseOnServer(purchase);\nif (isValid) {\n  await deliverContent(purchase.productId);\n}\n"})}),"\n",(0,a.jsx)(n.h3,{id:"6-transaction-finalization-phase",children:"6. Transaction Finalization Phase"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dart",children:"// Finish transaction (consume/acknowledge)\nawait iap.finishTransaction(\n  purchase: purchase,\n  isConsumable: true,\n);\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"States"}),": ",(0,a.jsx)(n.code,{children:"pending"})," \u2192 ",(0,a.jsx)(n.code,{children:"finished"})]}),"\n",(0,a.jsx)(n.h2,{id:"purchase-state-management",children:"Purchase State Management"}),"\n",(0,a.jsx)(n.h3,{id:"track-purchase-states",children:"Track Purchase States"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dart",children:"enum PurchaseState {\n  idle,\n  loading,\n  purchasing,\n  purchased,\n  failed,\n  cancelled,\n}\n\nclass PurchaseManager extends ChangeNotifier {\n  PurchaseState _state = PurchaseState.idle;\n  PurchaseState get state => _state;\n\n  void setState(PurchaseState newState) {\n    _state = newState;\n    notifyListeners();\n  }\n}\n"})}),"\n",(0,a.jsx)(n.h2,{id:"pending-transactions",children:"Pending Transactions"}),"\n",(0,a.jsx)(n.p,{children:"Handle purchases that didn't complete:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dart",children:"Future<void> checkPendingPurchases() async {\n  final purchases = await iap.getAvailablePurchases();\n\n  for (final purchase in purchases) {\n    // Check if already delivered\n    final isDelivered = await checkIfDelivered(purchase.transactionId);\n\n    if (!isDelivered) {\n      // Deliver and finish\n      await deliverContent(purchase.productId);\n      await iap.finishTransaction(\n        purchase: purchase,\n        isConsumable: false,\n      );\n    }\n  }\n}\n"})}),"\n",(0,a.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Initialize early"})," - Connect to store on app startup"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Check pending purchases"})," - Handle incomplete transactions on launch"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Maintain state"})," - Track purchase states for UI feedback"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Clean up properly"})," - End connection when no longer needed"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.a,{href:"./purchases",children:"Purchases"})," - Basic purchase implementation"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.a,{href:"./subscription-offers",children:"Subscription Offers"})," - Subscription lifecycle"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.a,{href:"./error-handling",children:"Error Handling"})," - Handle lifecycle errors"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(o,{...e})}):o(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>r,x:()=>t});var i=s(6540);const a={},c=i.createContext(a);function r(e){const n=i.useContext(c);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),i.createElement(c.Provider,{value:n},e.children)}}}]);