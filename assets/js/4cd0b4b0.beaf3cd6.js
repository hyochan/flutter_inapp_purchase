"use strict";(self.webpackChunkflutter_inapp_purchase_docs=self.webpackChunkflutter_inapp_purchase_docs||[]).push([[7280],{25931:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>d,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>u});const r=JSON.parse('{"id":"examples/subscription-flow","title":"Subscription Flow","description":"Source Code: subscriptionflowscreen.dart","source":"@site/docs/examples/subscription-flow.md","sourceDirName":"examples","slug":"/examples/subscription-flow","permalink":"/flutter_inapp_purchase/examples/subscription-flow","draft":false,"unlisted":false,"editUrl":"https://github.com/hyochan/flutter_inapp_purchase/tree/main/docs/docs/examples/subscription-flow.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2},"sidebar":"docsSidebar","previous":{"title":"Purchase Flow","permalink":"/flutter_inapp_purchase/examples/purchase-flow"},"next":{"title":"Available Purchases","permalink":"/flutter_inapp_purchase/examples/available-purchases"}}');var s=i(74848),t=i(28453),a=i(35159),c=i(71437);const o={sidebar_position:2},d="Subscription Flow",l={},u=[{value:"Key Features",id:"key-features",level:2},{value:"Implementation Overview",id:"implementation-overview",level:2},{value:"1. Set Up Listeners",id:"1-set-up-listeners",level:3},{value:"2. Fetch Subscription Products",id:"2-fetch-subscription-products",level:3},{value:"3. Check Active Subscriptions",id:"3-check-active-subscriptions",level:3},{value:"4. Purchase Subscription",id:"4-purchase-subscription",level:3},{value:"5. Upgrade/Downgrade Subscription (Android)",id:"5-upgradedowngrade-subscription-android",level:3},{value:"Android Replacement Modes",id:"android-replacement-modes",level:2},{value:"IAPKit Server Verification",id:"iapkit-server-verification",level:2},{value:"Complete Verification Flow",id:"complete-verification-flow",level:3},{value:"IAPKit Purchase States",id:"iapkit-purchase-states",level:3},{value:"Checking Subscription Status on App Launch",id:"checking-subscription-status-on-app-launch",level:3},{value:"Best Practices",id:"best-practices",level:2}];function p(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"subscription-flow",children:"Subscription Flow"})}),"\n",(0,s.jsx)(a.A,{}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Source Code"}),": ",(0,s.jsx)(n.a,{href:"https://github.com/hyochan/flutter_inapp_purchase/blob/main/example/lib/src/screens/subscription_flow_screen.dart",children:"subscription_flow_screen.dart"})]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"This example demonstrates how to implement subscription purchases with support for upgrades, downgrades, and subscription management."}),"\n",(0,s.jsx)(n.h2,{id:"key-features",children:"Key Features"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Fetch subscription products"}),"\n",(0,s.jsx)(n.li,{children:"Handle subscription purchases"}),"\n",(0,s.jsx)(n.li,{children:"Check active subscriptions"}),"\n",(0,s.jsx)(n.li,{children:"Manage subscription upgrades/downgrades (Android)"}),"\n",(0,s.jsx)(n.li,{children:"Listen to subscription events"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"implementation-overview",children:"Implementation Overview"}),"\n",(0,s.jsx)(n.h3,{id:"1-set-up-listeners",children:"1. Set Up Listeners"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"StreamSubscription<Purchase>? _purchaseUpdatedSubscription;\nStreamSubscription<PurchaseError>? _purchaseErrorSubscription;\n\nvoid _setupListeners() {\n  _purchaseUpdatedSubscription = iap.purchaseUpdatedListener.listen(\n    (purchase) {\n      _handlePurchase(purchase);\n    },\n  );\n\n  _purchaseErrorSubscription = iap.purchaseErrorListener.listen(\n    (error) {\n      _handleError(error);\n    },\n  );\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"2-fetch-subscription-products",children:"2. Fetch Subscription Products"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"final result = await iap.fetchProducts(\n  ProductRequest(\n    skus: ['monthly_sub', 'yearly_sub'],\n    type: ProductQueryType.Subs,\n  ),\n);\n\nif (result is FetchProductsResultSubscriptions) {\n  final subscriptions = result.value ?? [];\n  for (final product in subscriptions) {\n    if (product is ProductSubscriptionIOS) {\n      debugPrint('iOS Subscription: ${product.displayName}');\n    } else if (product is ProductSubscriptionAndroid) {\n      debugPrint('Android Subscription: ${product.title}');\n    }\n  }\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"3-check-active-subscriptions",children:"3. Check Active Subscriptions"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"// Lightweight check - returns only subscription IDs and expiry dates\nfinal summaries = await iap.getActiveSubscriptions(['monthly_sub']);\nif (summaries.isNotEmpty) {\n  debugPrint('Active subscription: ${summaries.first.productId}');\n  debugPrint('Expires: ${summaries.first.expirationDateIOS}');\n}\n\n// Detailed check - returns full purchase objects\nfinal purchases = await iap.getAvailablePurchases(\n  PurchaseOptions(onlyIncludeActiveItemsIOS: true),\n);\n"})}),"\n",(0,s.jsx)(n.h3,{id:"4-purchase-subscription",children:"4. Purchase Subscription"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"await iap.requestPurchase(\n  RequestPurchaseProps.subs((\n    apple: RequestPurchaseIosProps(\n      sku: 'monthly_sub',\n      quantity: 1,\n    ),\n    google: RequestPurchaseAndroidProps(\n      skus: ['monthly_sub'],\n    ),\n    useAlternativeBilling: null,\n  )),\n);\n"})}),"\n",(0,s.jsx)(n.h3,{id:"5-upgradedowngrade-subscription-android",children:"5. Upgrade/Downgrade Subscription (Android)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"await iap.requestPurchase(\n  RequestPurchaseProps.subs((\n    apple: RequestPurchaseIosProps(\n      sku: 'yearly_sub',\n      quantity: 1,\n    ),\n    google: RequestPurchaseAndroidProps(\n      skus: ['yearly_sub'],\n      replacementModeAndroid: AndroidReplacementMode.withTimeProration,\n    ),\n    useAlternativeBilling: null,\n  )),\n);\n"})}),"\n",(0,s.jsx)(n.h2,{id:"android-replacement-modes",children:"Android Replacement Modes"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"enum AndroidReplacementMode {\n  withTimeProration,      // 1: Credit unused time towards new subscription\n  chargeProratedPrice,    // 2: Charge prorated price immediately\n  withoutProration,       // 3: No credit for unused time\n  deferred,               // 4: New subscription starts at next renewal\n  chargeFullPrice,        // 5: Charge full price immediately\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"iapkit-server-verification",children:"IAPKit Server Verification"}),"\n",(0,s.jsxs)(n.p,{children:["Use ",(0,s.jsx)(c.A,{children:"IAPKit"})," for enterprise-grade purchase verification without maintaining your own validation infrastructure."]}),"\n",(0,s.jsx)(n.h3,{id:"complete-verification-flow",children:"Complete Verification Flow"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"Future<void> _handlePurchaseWithVerification(Purchase purchase) async {\n  // 1. Verify purchase with IAPKit\n  final result = await iap.verifyPurchaseWithProvider(\n    VerifyPurchaseWithProviderProps(\n      provider: VerifyPurchaseProvider.iapkit,\n      iapkit: RequestVerifyPurchaseWithIapkitProps(\n        apiKey: 'your-iapkit-api-key',\n        apple: RequestVerifyPurchaseWithIapkitAppleProps(\n          jws: purchase.purchaseToken,\n        ),\n        google: RequestVerifyPurchaseWithIapkitGoogleProps(\n          purchaseToken: purchase.purchaseToken,\n        ),\n      ),\n    ),\n  );\n\n  // 2. Handle verification result\n  if (result.iapkit case final iapkit?) {\n    switch (iapkit.state) {\n      case IapkitPurchaseState.Entitled:\n        // Purchase is valid - grant access\n        await grantPremiumAccess(purchase.productId);\n        await iap.finishTransaction(purchase: purchase, isConsumable: false);\n      case IapkitPurchaseState.Expired:\n        // Subscription expired\n        await revokePremiumAccess(purchase.productId);\n      case IapkitPurchaseState.Inauthentic:\n        // Fraudulent purchase detected\n        debugPrint('Inauthentic purchase detected');\n      default:\n        debugPrint('Purchase state: ${iapkit.state}');\n    }\n  }\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"iapkit-purchase-states",children:"IAPKit Purchase States"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"State"}),(0,s.jsx)(n.th,{children:"Description"}),(0,s.jsx)(n.th,{children:"Recommended Action"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"entitled"})}),(0,s.jsx)(n.td,{children:"User has active subscription"}),(0,s.jsx)(n.td,{children:"Grant premium access"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"expired"})}),(0,s.jsx)(n.td,{children:"Subscription has expired"}),(0,s.jsx)(n.td,{children:"Revoke access, show renewal prompt"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"canceled"})}),(0,s.jsx)(n.td,{children:"User canceled, may have time remaining"}),(0,s.jsx)(n.td,{children:"Check expiration date"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"pending"})}),(0,s.jsx)(n.td,{children:"Purchase pending (parental approval, etc.)"}),(0,s.jsx)(n.td,{children:"Show pending UI"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"pending-acknowledgment"})}),(0,s.jsx)(n.td,{children:"Needs acknowledgment (Android)"}),(0,s.jsxs)(n.td,{children:["Call ",(0,s.jsx)(n.code,{children:"finishTransaction()"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"inauthentic"})}),(0,s.jsx)(n.td,{children:"Failed validation"}),(0,s.jsx)(n.td,{children:"Do not grant access"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"checking-subscription-status-on-app-launch",children:"Checking Subscription Status on App Launch"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"class SubscriptionManager {\n  final _iap = FlutterInappPurchase.instance;\n  final String _apiKey;\n\n  SubscriptionManager({required String apiKey}) : _apiKey = apiKey;\n\n  Future<bool> checkSubscriptionOnLaunch(List<String> subscriptionIds) async {\n    try {\n      // Get all available purchases\n      final purchases = await _iap.getAvailablePurchases();\n\n      // Filter to subscriptions only\n      final subscriptionPurchases = purchases.where(\n        (p) => subscriptionIds.contains(p.productId),\n      );\n\n      for (final purchase in subscriptionPurchases) {\n        final result = await _iap.verifyPurchaseWithProvider(\n          VerifyPurchaseWithProviderProps(\n            provider: VerifyPurchaseProvider.iapkit,\n            iapkit: RequestVerifyPurchaseWithIapkitProps(\n              apiKey: _apiKey,\n              apple: RequestVerifyPurchaseWithIapkitAppleProps(\n                jws: purchase.purchaseToken,\n              ),\n              google: RequestVerifyPurchaseWithIapkitGoogleProps(\n                purchaseToken: purchase.purchaseToken,\n              ),\n            ),\n          ),\n        );\n\n        if (result.iapkit case final iapkit? when iapkit.isValid) {\n          return true; // Active subscription found\n        }\n      }\n\n      return false; // No active subscription\n    } catch (e) {\n      debugPrint('Failed to check subscription: $e');\n      return false;\n    }\n  }\n}\n\n// Usage\nfinal manager = SubscriptionManager(apiKey: 'your-iapkit-api-key');\nfinal isSubscribed = await manager.checkSubscriptionOnLaunch([\n  'monthly_subscription',\n  'yearly_subscription',\n]);\n"})}),"\n",(0,s.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Use lightweight checks"})," - Use ",(0,s.jsx)(n.code,{children:"getActiveSubscriptions()"})," for quick status checks"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Verify server-side"})," - Always validate subscription status with ",(0,s.jsx)(c.A,{children:"IAPKit"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Handle upgrades properly"})," - Choose appropriate replacement mode for Android"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Check subscription status"})," - Verify on app launch and app resume"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Handle expiration"})," - Monitor subscription expiry dates and renewal status"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Check renewals on Android"})," - ",(0,s.jsx)(n.code,{children:"purchaseUpdatedListener"})," doesn't fire for renewals while app is closed"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(p,{...e})}):p(e)}},27856:(e,n,i)=>{i.d(n,{I:()=>s,V:()=>r});const r="https://iapkit.com",s="https://www.hyo.dev/api/ad-banner/cmjf0l1x30001249hbi91aop6"},28453:(e,n,i)=>{i.d(n,{R:()=>a,x:()=>c});var r=i(96540);const s={},t=r.createContext(s);function a(e){const n=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),r.createElement(t.Provider,{value:n},e.children)}},35159:(e,n,i)=>{i.d(n,{A:()=>t});i(96540);var r=i(27856),s=i(74848);function t({style:e}){return(0,s.jsx)("div",{style:{marginTop:24,marginBottom:24,textAlign:"center",...e},children:(0,s.jsx)("a",{href:r.V,target:"_blank",rel:"noopener noreferrer",onClick:async()=>{try{await fetch(r.I,{method:"POST",mode:"no-cors"})}catch(e){}},children:(0,s.jsx)("img",{src:i(65860).A,alt:"IapKit - Fraud-proof your in-app purchases",style:{objectFit:"cover",border:"none"}})})})}},65860:(e,n,i)=>{i.d(n,{A:()=>r});const r=i.p+"assets/images/iapkit-banner-c71d8c3f875ca90b812e7b54822795d2.gif"},71437:(e,n,i)=>{i.d(n,{A:()=>t});i(96540);var r=i(27856),s=i(74848);function t({children:e,path:n=""}){return(0,s.jsx)("a",{href:`${r.V}${n}`,target:"_blank",rel:"noopener noreferrer",onClick:async()=>{try{await fetch(r.I,{method:"POST",mode:"no-cors"})}catch(e){}},children:e})}}}]);