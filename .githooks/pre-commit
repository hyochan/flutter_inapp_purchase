#!/usr/bin/env bash
set -euo pipefail

echo "[pre-commit] Running flutter pub get..."
flutter pub get >/dev/null

echo "[pre-commit] Auto-formatting staged Dart files..."
# Collect staged Dart files and format them in place
STAGED_DART_FILES=$(git diff --cached --name-only --diff-filter=ACMRT | grep -E '\.dart$' || true)
if [ -n "$STAGED_DART_FILES" ]; then
  dart format $STAGED_DART_FILES >/dev/null
  # Re-stage formatted files
  echo "$STAGED_DART_FILES" | xargs git add -A --
fi

echo "[pre-commit] Checking dart format across repo..."
dart format --output=none --set-exit-if-changed .

echo "[pre-commit] Running tests (fast fail)..."
flutter test --concurrency=4

echo "[pre-commit] OK"
