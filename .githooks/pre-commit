#!/usr/bin/env bash
set -euo pipefail

echo "[pre-commit] Running flutter pub get..."
flutter pub get >/dev/null

echo "[pre-commit] Auto-formatting staged Dart files..."
# Collect staged Dart files and format them in place
STAGED_DART_FILES=$(git diff --cached --name-only --diff-filter=ACMRT | grep -E '\.dart$' || true)
if [ -n "$STAGED_DART_FILES" ]; then
  dart format $STAGED_DART_FILES >/dev/null
  # Re-stage formatted files
  echo "$STAGED_DART_FILES" | xargs git add -A --
fi

echo "[pre-commit] Verifying format on staged Dart files..."
if [ -n "$STAGED_DART_FILES" ]; then
  dart format --output=none --set-exit-if-changed $STAGED_DART_FILES
fi

echo "[pre-commit] Running analyzer..."
if [ "${ENFORCE_ANALYZE:-0}" = "1" ]; then
  flutter analyze
else
  # Do not fail commit on analyzer warnings by default
  flutter analyze || true
fi

if [ "${SKIP_PRECOMMIT_TESTS:-0}" != "1" ]; then
  echo "[pre-commit] Running tests (fast fail)..."
  flutter test --concurrency="${PRECOMMIT_TEST_CONCURRENCY:-4}"
fi

echo "[pre-commit] OK"
